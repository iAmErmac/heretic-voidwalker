
Class HVROffhandWeapHandler : Eventhandler
{
	override void WorldTick()
	{
		if(_isTitlemap) return;
		
		Playerinfo player = Players[ConsolePlayer];
		if(!player) return;
		let pmo = player.mo;
		
		if(level.time > 35)
		{
			let weap = Weapon(pmo.FindInventory("HVRStaff"));
			weap.bNohandswitch = true;
			
			let gauntlet = Weapon(pmo.FindInventory("HVRGauntlets"));
			let powergauntlet = Weapon(pmo.FindInventory("HVRGauntletsPowered"));
			if(player.ReadyWeapon == gauntlet)
			{
				pmo.giveinventory("OffhandGauntlet", 1);
				let gauntlet2 = Weapon(pmo.FindInventory("OffhandGauntlet"));
				if(player.OffhandWeapon == gauntlet2) return;
				
				player.OffhandWeapon = gauntlet2;
				player.PendingWeapon = gauntlet2;
				pmo.BringUpWeapon();
				return;
			}
			else if(player.ReadyWeapon == powergauntlet)
			{
				pmo.giveinventory("OffhandGauntletPowered", 1);
				let gauntlet2 = Weapon(pmo.FindInventory("OffhandGauntletPowered"));
				if(player.OffhandWeapon == gauntlet2) return;
				
				player.OffhandWeapon = gauntlet2;
				player.PendingWeapon = gauntlet2;
				pmo.BringUpWeapon();
				return;
			}
			else
			{
				if(pmo.countinv("OffhandGauntlet")) pmo.takeinventory("OffhandGauntlet", 1);
				if(pmo.countinv("OffhandGauntletPowered")) pmo.takeinventory("OffhandGauntletPowered", 1);
			}
			
			if(!player.ReadyWeapon)
			{
				weap.bOffhandweapon = false;
				player.ReadyWeapon = weap;
				player.PendingWeapon = weap;
				pmo.BringUpWeapon();
			}
			else if(!player.OffhandWeapon)
			{
				weap.bOffhandweapon = true;
				player.OffhandWeapon = weap;
				player.PendingWeapon = weap;
				pmo.BringUpWeapon();
			}
		}
	}

	override void WorldLoaded(WorldEvent event)
	{
		_isTitlemap = CheckTitlemap();
	}

	private static bool CheckTitlemap()
	{
		bool isTitlemap = (level.mapname == "TITLEMAP");
		return isTitlemap;
	}
	
	private bool _isTitlemap;
}

Class HVRHapticHelper : EventHandler
{
	static void BuzzHand(int hand = 0)
	{
		Let player = Players[ConsolePlayer].mo;
		if(!player || player.health < 1) return;
		
		player.LineAttack(0, 0, 0, 1, "melee", "HVRhapticDummyPuff", LAF_NOIMPACTDECAL | LAF_NOINTERACT | LAF_NORANDOMPUFFZ | (hand ? LAF_ISOFFHAND : 0));
	}
	
	static void Buzz()
	{
		HVRHapticHelper.BuzzHand();
		HVRHapticHelper.BuzzHand(1);
	}
	
	static void BuzzOffhand()
	{
		HVRHapticHelper.BuzzHand(1);
	}
	
	static void BuzzWeapon(Weapon weap)
	{
		if(!weap || !weap.owner) return;
		
		int hand = weap.bOffhandWeapon ? 1 : 0;
		HVRHapticHelper.BuzzHand(hand);
	}
}

Class HVRhapticDummyPuff : Actor
{
	Default
	{
		Mass        0;
		Radius      1;
		Height      2;
		Damage 		1;
		DamageType "Melee";
		+NOBLOCKMAP;
		+NOGRAVITY;
		+BLOODLESSIMPACT;
		+PUFFONACTORS;
		+DONTSPLASH;
		+NOTRIGGER;
		+NOTARGET;
		+FORCEXYBILLBOARD;
		+NOTONAUTOMAP;
		+SKYEXPLODE;
	}

	States
	{
	Spawn:
		TNT1 A 0;
		TNT1 A 1;
		stop;
	}
}